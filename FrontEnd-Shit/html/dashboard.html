<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipidTech - Dashboard</title>
    <link rel="stylesheet" href="../css/homepage.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="navbar">
        <div class="container">
            <div class="navbar-content">
                <div class="logo">
                    <img src="../icons/pig-icon.png" alt="TipidTech" class="logo-icon-img">
                    <span class="logo-text">TipidTech</span>
                </div>
                <nav class="nav-links">
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="expenses.html" class="nav-link">Expenses</a>
                    <a href="#" class="nav-link">Goals</a>
                    <a href="#" class="nav-link">Settings</a>
                    <button class="btn-logout" onclick="confirmLogout()">Logout</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard">
        <div class="container">
            <!-- Greeting Section -->
            <section class="greeting-section">
                <div class="greeting-content">
                    <h1 id="greetingName">Good morning!</h1>
                    <p class="greeting-subtitle" id="greetingDate">Here's your financial overview for December 2024</p>
                </div>
                <div class="account-badge"><img src="../icons/ai-icon.png" alt="AI" class="badge-icon"> Professional Account</div>
            </section>

            <!-- Stats Cards -->
            <section class="stats-grid">
                <div class="stat-card budget-card fade-in-card">
                    <div class="stat-header">
                        <span class="stat-label">Total Budget</span>
                    </div>
                    <div class="stat-amount" id="totalBudget">‚Ç±20,000</div>
                </div>

                <div class="stat-card spent-card fade-in-card">
                    <div class="stat-header">
                        <span class="stat-label">Spent This Month</span>
                    </div>
                    <div class="stat-amount" id="spentAmount">‚Ç±0</div>
                    <div class="stat-change" id="spentChange">No expenses yet</div>
                </div>

                <div class="stat-card remaining-card fade-in-card">
                    <div class="stat-header">
                        <span class="stat-label">Remaining</span>
                    </div>
                    <div class="stat-amount" id="remainingAmount">‚Ç±20,000</div>
                    <div class="stat-change" id="remainingChange">100% of budget remaining</div>
                </div>
            </section>

            <!-- AI Insight Card -->
            <section class="ai-insight-card fade-in-card">
                <div class="insight-icon"><img src="../icons/sparkle-icon.png" alt="AI Insight"></div>
                <div class="insight-content">
                    <h3>AI Insight</h3>
                    <p>You spent 15% less on food this week. Great progress!</p>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="charts-grid">
                <!-- Spending Trend -->
                <div class="chart-card fade-in-card">
                    <h3 class="chart-title">Spending Trend</h3>
                    <div class="chart-container">
                        <svg class="line-chart" viewBox="0 0 400 200" preserveAspectRatio="xMidYMid meet">
                            <!-- Grid lines -->
                            <line x1="40" y1="160" x2="380" y2="160" stroke="#e5e7eb" stroke-width="1" />
                            <line x1="40" y1="120" x2="380" y2="120" stroke="#e5e7eb" stroke-width="1" />
                            <line x1="40" y1="80" x2="380" y2="80" stroke="#e5e7eb" stroke-width="1" />
                            <line x1="40" y1="40" x2="380" y2="40" stroke="#e5e7eb" stroke-width="1" />
                            
                            <!-- Y-axis labels -->
                            <text x="30" y="165" font-size="12" fill="#9ca3af" text-anchor="end" font-weight="500">‚Ç±0k</text>
                            <text x="30" y="125" font-size="12" fill="#9ca3af" text-anchor="end" font-weight="500">‚Ç±1.5k</text>
                            <text x="30" y="85" font-size="12" fill="#9ca3af" text-anchor="end" font-weight="500">‚Ç±3k</text>
                            <text x="30" y="45" font-size="12" fill="#9ca3af" text-anchor="end" font-weight="500">‚Ç±4.5k</text>
                            
                            <!-- Line path -->
                            <polyline points="60,100 140,80 220,70 300,120" fill="none" stroke="#0d5adf" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            
                            <!-- Points -->
                            <circle cx="60" cy="100" r="4" fill="#0d5adf" />
                            <circle cx="140" cy="80" r="4" fill="#0d5adf" />
                            <circle cx="220" cy="70" r="4" fill="#0d5adf" />
                            <circle cx="300" cy="120" r="4" fill="#0d5adf" />
                            
                            <!-- X-axis labels -->
                            <text x="60" y="185" font-size="12" fill="#9ca3af" text-anchor="middle" font-weight="500">Week 1</text>
                            <text x="140" y="185" font-size="12" fill="#9ca3af" text-anchor="middle" font-weight="500">Week 2</text>
                            <text x="220" y="185" font-size="12" fill="#9ca3af" text-anchor="middle" font-weight="500">Week 3</text>
                            <text x="300" y="185" font-size="12" fill="#9ca3af" text-anchor="middle" font-weight="500">Week 4</text>
                        </svg>
                    </div>
                </div>

                <!-- Financial Health Score -->
                <div class="score-card fade-in-card">
                    <div class="score-header">
                        <h3 class="score-title">Financial Health Score</h3>
                        <span class="ai-powered"><img src="../icons/ai-icon.png" alt="AI" class="badge-icon"> AI Powered</span>
                    </div>
                    <div class="circular-score">
                        <svg viewBox="0 0 120 120" class="score-svg" id="scoreCircle">
                            <!-- Background circle -->
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#e5e7eb" stroke-width="8" />
                            <!-- Progress circle -->
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#10b981" stroke-width="8" stroke-dasharray="261.8" stroke-dashoffset="94.5" stroke-linecap="round" transform="rotate(-90 60 60)" />
                        </svg>
                        <div class="score-text">
                            <span class="score-number">78</span>
                            <span class="score-label">out of 100</span>
                        </div>
                    </div>
                    <p class="score-status">Good</p>
                    <p class="score-change">+6 from last month</p>
                    <div class="recommendations">
                        <h4>AI Recommendations:</h4>
                        <p><img src="../icons/idea-icon.png" alt="Idea" class="recommendation-icon"> Consider setting aside ‚Ç±500 more for your emergency fund.</p>
                    </div>
                </div>
            </section>

            <!-- Bottom Sections -->
            <section class="bottom-sections">
                <!-- Spending by Category -->
                <div class="category-section fade-in-card">
                    <h3 class="section-title">Spending by Category</h3>
                    <div class="pie-chart-container">
                        <svg class="pie-chart" viewBox="0 0 140 140" preserveAspectRatio="xMidYMid meet">
                            <!-- Background circle for better contrast -->
                            <circle cx="70" cy="70" r="55" fill="none" stroke="#f3f4f6" stroke-width="1" opacity="0.3" />
                            <!-- Pie segments will be generated by JavaScript -->
                        </svg>
                    </div>
                    <div class="category-legend">
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #0d5adf;"></span>
                            <span class="legend-label">Food</span>
                            <span class="legend-amount">‚Ç±4,200</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #10b981;"></span>
                            <span class="legend-label">Transport</span>
                            <span class="legend-amount">‚Ç±3,100</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #8b5cf6;"></span>
                            <span class="legend-label">Shopping</span>
                            <span class="legend-amount">‚Ç±2,800</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #ec4899;"></span>
                            <span class="legend-label">Entertainment</span>
                            <span class="legend-amount">‚Ç±1,500</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #f59e0b;"></span>
                            <span class="legend-label">Other</span>
                            <span class="legend-amount">‚Ç±850</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Expenses -->
                <div class="recent-expenses fade-in-card">
                    <div class="expenses-header">
                        <h3 class="section-title">Recent Expenses</h3>
                        <a href="expenses.html" class="view-all">View All ‚Üí</a>
                    </div>
                    <div class="expenses-list">
                        <div class="expense-item">
                            <div class="expense-icon">üçΩÔ∏è</div>
                            <div class="expense-details">
                                <p class="expense-name">Lunch at Jollibee</p>
                                <p class="expense-time">2 hours ago</p>
                            </div>
                            <span class="expense-amount">‚Ç±285</span>
                        </div>
                        <div class="expense-item">
                            <div class="expense-icon">üöï</div>
                            <div class="expense-details">
                                <p class="expense-name">Grab to work</p>
                                <p class="expense-time">5 hours ago</p>
                            </div>
                            <span class="expense-amount">‚Ç±150</span>
                        </div>
                        <div class="expense-item">
                            <div class="expense-icon">üõí</div>
                            <div class="expense-details">
                                <p class="expense-name">Groceries at SM</p>
                                <p class="expense-time">Yesterday</p>
                            </div>
                            <span class="expense-amount">‚Ç±890</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Savings Goal Progress -->
            <section class="savings-goal fade-in-card" id="savingsGoalSection">
                <div class="goal-header">
                    <h3 class="section-title">Savings Goal Progress</h3>
                </div>
                <div class="goal-amount">‚Ç±3,200 / ‚Ç±5,000</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: 64%;"></div>
                </div>
                <p class="progress-text">64% complete</p>
            </section>
        </div>
    </main>

    <!-- AI Chat Button -->
    <button class="ai-chat-button" id="aiChatBtn" aria-label="Open AI Chat">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 9H16M8 13H14M6 21H18C19.1046 21 20 20.1046 20 19V5C20 3.89543 19.1046 3 18 3H6C4.89543 3 4 3.89543 4 5V19C4 20.1046 4.89543 21 6 21Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- AI Chat Popup -->
    <div class="ai-chat-popup" id="aiChatPopup">
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">
                        <img src="../icons/chatbot1-icon.png" alt="TipidTech AI">
                </div>
                <div class="chat-title">
                    <h4>TipidTech AI</h4>
                    <p>Your Budget Coach</p>
                </div>
            </div>
            <button class="chat-close" id="chatCloseBtn" aria-label="Close chat">‚úï</button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message ai-message">
                <div class="message-avatar">
                    <img src="../icons/chatbot2-icon.png" alt="AI">
                </div>
                <div class="message-content">
                    <p>Hi there! üëã I'm your AI Budget Coach. I can help you track spending, give tips, and answer budgeting questions. What would you like to know?</p>
                </div>
            </div>
        </div>

        <div class="quick-actions">
            <button class="quick-action-btn" onclick="sendQuickAction('Show my spending')">Show my spending</button>
            <button class="quick-action-btn" onclick="sendQuickAction('Budget tips')">Budget tips</button>
            <button class="quick-action-btn" onclick="sendQuickAction('How can I save more?')">How can I save more?</button>
            <button class="quick-action-btn" onclick="sendQuickAction('Savings goal progress')">Savings goal progress</button>
        </div>

        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything about budgeting..." />
            <button class="chat-send-btn" id="chatSendBtn" aria-label="Send message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>

    <script type="module" src="../js/main.js"></script>
    <script>
        // Logout confirmation
        function confirmLogout() {
            const confirmed = confirm('Are you sure you want to logout? You will need to sign in again.');
            if (confirmed) {
                // Clear user data from localStorage
                localStorage.clear();
                // Redirect to homepage
                window.location.href = 'index.html';
            }
        }

        // Populate dashboard with user data from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            // Get stored data
            const expectedIncome = localStorage.getItem('expectedIncome') || '20000';
            const storedName = (localStorage.getItem('userName') || localStorage.getItem('username') || '').trim();
            const displayName = storedName || 'there';

            // Personalize greeting and chat intro
            const greetingEl = document.getElementById('greetingName');
            if (greetingEl) {
                greetingEl.textContent = storedName ? `Good morning, ${storedName}!` : 'Good morning!';
            }

            const aiIntroEl = document.querySelector('.chat-messages .ai-message .message-content p');
            if (aiIntroEl) {
                aiIntroEl.textContent = `Hi ${displayName}! üëã I'm your AI Budget Coach. I can help you track spending, give tips, and answer budgeting questions. What would you like to know?`;
            }
            
            // Update greeting with current date/month
            const today = new Date();
            const monthYear = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('greetingDate').textContent = `Here's your financial overview for ${monthYear}`;
            
            // Calculate spent amount from expenses
            let expenses = [];
            let totalSpent = 0;
            try {
                expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                totalSpent = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            } catch (e) {
                totalSpent = 0;
            }
            
            const incomeAmount = parseInt(expectedIncome);
            const remainingAmount = incomeAmount - totalSpent;
            const spentPercentage = Math.round((totalSpent / incomeAmount) * 100);
            const remainingPercentage = Math.round((remainingAmount / incomeAmount) * 100);
            
            // Update stats with real data
            document.getElementById('totalBudget').textContent = `‚Ç±${incomeAmount.toLocaleString()}`;
            document.getElementById('spentAmount').textContent = `‚Ç±${totalSpent.toLocaleString()}`;
            document.getElementById('remainingAmount').textContent = `‚Ç±${remainingAmount.toLocaleString()}`;
            
            // Update stat change messages
            const spentChangeEl = document.getElementById('spentChange');
            const remainingChangeEl = document.getElementById('remainingChange');
            
            if (totalSpent === 0) {
                spentChangeEl.textContent = 'No expenses yet';
                spentChangeEl.className = 'stat-change neutral';
            } else {
                spentChangeEl.textContent = `${spentPercentage}% of budget spent`;
                spentChangeEl.className = spentPercentage > 70 ? 'stat-change negative' : 'stat-change positive';
            }
            
            remainingChangeEl.textContent = `${remainingPercentage}% of budget remaining`;
            remainingChangeEl.className = remainingPercentage > 50 ? 'stat-change positive' : 'stat-change negative';
            
            // Get target amount for savings goal
            const targetAmount = localStorage.getItem('targetAmount');
            
            // ===== SPENDING TREND CHART (by week) =====
            const weekSpending = [0, 0, 0, 0]; // 4 weeks (Week 1, 2, 3, 4)
            
            expenses.forEach(exp => {
                const expDate = new Date(exp.date);
                const daysDiff = Math.floor((today - expDate) / (1000 * 60 * 60 * 24));
                const weekIndex = Math.floor(daysDiff / 7);
                if (weekIndex >= 0 && weekIndex < 4) {
                    weekSpending[weekIndex] += parseFloat(exp.amount || 0);
                }
            });
            
            // Find max spending for scaling
            const maxSpending = Math.max(...weekSpending, 4500);
            const scale = 160 / maxSpending; // SVG height mapping
            
            // Calculate SVG points for line chart
            const points = weekSpending.map((spending, i) => {
                const x = 60 + (i * 80);
                const y = 160 - (spending * scale);
                return { x, y, spending };
            });
            
            const polylinePoints = points.map(p => `${p.x},${p.y}`).join(' ');
            const spendingChartSvg = document.querySelector('.line-chart');
            
            // Update polyline
            const polyline = spendingChartSvg.querySelector('polyline');
            polyline.setAttribute('points', polylinePoints);
            
            // Update circles
            const circles = spendingChartSvg.querySelectorAll('circle');
            points.forEach((point, i) => {
                if (circles[i]) {
                    circles[i].setAttribute('cx', point.x);
                    circles[i].setAttribute('cy', point.y);
                }
            });
            
            // ===== SPENDING BY CATEGORY PIE CHART =====
            const categorySpending = {};
            const categoryColors = {
                'Transportation': '#0d5adf',
                'Food & Dining': '#10b981',
                'Bills & Utilities': '#8b5cf6',
                'Shopping': '#ec4899',
                'Mobile & Internet': '#06b6d4',
                'Healthcare': '#f59e0b',
                'Entertainment': '#ef4444',
                'Other': '#6b7280'
            };
            
            expenses.forEach(exp => {
                const catName = exp.category?.name || 'Other';
                categorySpending[catName] = (categorySpending[catName] || 0) + parseFloat(exp.amount || 0);
            });
            
            const totalByCategory = Object.values(categorySpending).reduce((a, b) => a + b, 0) || 1;
            const categoryLegend = document.querySelector('.category-legend');
            const pieSvg = document.querySelector('.pie-chart');
            
            if (categoryLegend && pieSvg) {
                categoryLegend.innerHTML = '';
                // Clear existing circles but keep the viewBox and class
                const existingCircles = pieSvg.querySelectorAll('circle');
                existingCircles.forEach(circle => circle.remove());
                
                // Check if there are no expenses
                if (totalSpent === 0 || Object.keys(categorySpending).length === 0) {
                    categoryLegend.innerHTML = '';
                    // Hide the pie chart and show centered message
                    pieSvg.parentElement.innerHTML = '<p style="width: 100%; text-align: center; color: #9ca3af; font-size: 15px; margin: 0;">No expenses yet</p>';
                } else {
                    pieSvg.innerHTML = ''; // Clear previous circles
                    let cumulativeDashOffset = 0;
                    
                    Object.entries(categorySpending).forEach(([category, amount]) => {
                    const percentage = (amount / totalByCategory) * 100;
                    const circleLength = 251.2;
                    const gapSize = 1.5; // Small white gap between segments
                    const dashLength = (percentage / 100) * circleLength - gapSize;
                    const color = categoryColors[category] || '#6b7280';
                    
                    // Create new circle for pie chart
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', '60');
                    circle.setAttribute('cy', '60');
                    circle.setAttribute('r', '40');
                    circle.setAttribute('fill', 'none');
                    circle.setAttribute('stroke', color);
                    circle.setAttribute('stroke-width', '20');
                    circle.setAttribute('stroke-dasharray', `${dashLength} ${circleLength}`);
                    circle.setAttribute('stroke-dashoffset', `-${cumulativeDashOffset}`);
                    circle.setAttribute('transform', 'rotate(-90 60 60)');
                    pieSvg.appendChild(circle);
                    
                    cumulativeDashOffset += (percentage / 100) * circleLength;
                    
                    // Add legend item
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `
                        <span class="legend-dot" style="background: ${color};"></span>
                        <span class="legend-label">${category}</span>
                        <span class="legend-amount">‚Ç±${Math.round(amount).toLocaleString()}</span>
                    `;
                    categoryLegend.appendChild(legendItem);
                    });
                }
            }
            
            // ===== FINANCIAL HEALTH SCORE =====
            // Score calculation: Budget adherence (50%), savings rate (30%), expense tracking (20%)
            let healthScore = 0;
            
            // Budget adherence (50 points) - penalize overspending
            if (totalSpent === 0) {
                healthScore += 50; // Perfect if no spending yet
            } else if (spentPercentage <= 30) {
                healthScore += 50; // Excellent budget control
            } else if (spentPercentage <= 50) {
                healthScore += 45; // Very good
            } else if (spentPercentage <= 70) {
                healthScore += 35; // Good
            } else if (spentPercentage <= 85) {
                healthScore += 25; // Fair
            } else if (spentPercentage <= 100) {
                healthScore += 15; // Poor
            } else {
                healthScore += 5; // Over budget
            }
            
            // Savings rate (30 points)
            if (remainingPercentage >= 70) healthScore += 30;
            else if (remainingPercentage >= 50) healthScore += 25;
            else if (remainingPercentage >= 30) healthScore += 20;
            else if (remainingPercentage >= 15) healthScore += 10;
            else if (remainingPercentage > 0) healthScore += 5;
            
            // Expense tracking (20 points) - bonus for having tracked expenses
            if (totalSpent > 0) {
                const categoryCount = Object.keys(categorySpending).length;
                if (categoryCount >= 4) healthScore += 20;
                else if (categoryCount >= 3) healthScore += 15;
                else if (categoryCount >= 2) healthScore += 10;
                else healthScore += 5;
            } else {
                healthScore += 20; // Full points if starting fresh
            }
            
            // Cap at 100
            healthScore = Math.min(Math.max(healthScore, 0), 100);
            
            // Update score display
            const scoreNumber = document.querySelector('.score-number');
            const scoreStatus = document.querySelector('.score-status');
            if (scoreNumber) {
                scoreNumber.textContent = Math.round(healthScore);
                
                // Update progress circle
                const progressCircle = document.querySelector('.score-svg circle:nth-child(2)');
                const circumference = 314.159; // 2 * pi * 50
                const filledLength = circumference * (healthScore / 100);
                progressCircle.setAttribute('stroke-dasharray', `${filledLength} ${circumference}`);
                progressCircle.setAttribute('stroke-dashoffset', '0');
                
                // Update status text and color
                let statusText = 'Poor';
                let strokeColor = '#ef4444';
                if (healthScore >= 80) {
                    statusText = 'Excellent';
                    strokeColor = '#10b981';
                } else if (healthScore >= 70) {
                    statusText = 'Good';
                    strokeColor = '#3b82f6';
                } else if (healthScore >= 60) {
                    statusText = 'Fair';
                    strokeColor = '#f59e0b';
                }
                scoreStatus.textContent = statusText;
                progressCircle.setAttribute('stroke', strokeColor);
            }
            
            // ===== RECENT EXPENSES =====
            const categoryIconMap = {
                transportation: '../icons/bus-icon.png',
                food: '../icons/dining-icon.png',
                bills: '../icons/house-icon.png',
                shopping: '../icons/shop-icon.png',
                mobile: '../icons/device-icon.png',
                healthcare: '../icons/heart-icon.png',
                entertainment: '../icons/games-icon.png',
                other: '../icons/other-icon.png'
            };

            const expensesList = document.querySelector('.expenses-list');
            if (expensesList) {
                expensesList.innerHTML = '';
                
                // Sort by timestamp (oldest first) and take last 3
                const sortedExpenses = [...expenses].sort((a, b) => a.timestamp - b.timestamp).slice(-3);
                
                if (sortedExpenses.length === 0) {
                    expensesList.innerHTML = '<p style="padding: 20px; text-align: center; color: #9ca3af;">No expenses yet</p>';
                } else {
                    sortedExpenses.forEach(expense => {
                        const expDate = new Date(expense.timestamp);
                        const now = new Date();
                        let timeText = '';
                        
                        const diffMs = now - expDate;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMins / 60);
                        const diffDays = Math.floor(diffHours / 24);
                        
                        if (diffMins < 60) timeText = `${diffMins}m ago`;
                        else if (diffHours < 24) timeText = `${diffHours}h ago`;
                        else if (diffDays === 1) timeText = 'Yesterday';
                        else timeText = `${diffDays}d ago`;
                        
                        const iconPath = expense.category?.icon;
                        const mappedIcon = categoryIconMap[expense.category?.value];
                        const iconMarkup = (() => {
                            if (iconPath && (iconPath.includes('.png') || iconPath.includes('.svg'))) {
                                return `<img src="${iconPath}" alt="${expense.category?.name || 'Expense'}">`;
                            }
                            if (mappedIcon) {
                                return `<img src="${mappedIcon}" alt="${expense.category?.name || 'Expense'}">`;
                            }
                            return expense.category?.icon || 'üí∞';
                        })();
                        
                        const item = document.createElement('div');
                        item.className = 'expense-item';
                        item.innerHTML = `
                            <div class="expense-icon">${iconMarkup}</div>
                            <div class="expense-details">
                                <p class="expense-name">${expense.description || expense.category?.name || 'Expense'}</p>
                                <p class="expense-time">${timeText}</p>
                            </div>
                            <span class="expense-amount">‚Ç±${parseFloat(expense.amount).toLocaleString()}</span>
                        `;
                        expensesList.appendChild(item);
                    });
                }
            }
            
            // ===== SAVINGS GOAL PROGRESS =====
            const savingsGoalSection = document.getElementById('savingsGoalSection');
            
            if (targetAmount && parseFloat(targetAmount) > 0) {
                const goalAmount = parseFloat(targetAmount);
                const saved = remainingAmount > 0 ? Math.min(remainingAmount, goalAmount) : 0;
                const goalPercentage = Math.round((saved / goalAmount) * 100);
                
                const goalAmountEl = document.querySelector('.goal-amount');
                const progressBarFill = document.querySelector('.progress-bar-fill');
                const progressText = document.querySelector('.progress-text');
                
                if (goalAmountEl) {
                    goalAmountEl.textContent = `‚Ç±${Math.round(saved).toLocaleString()} / ‚Ç±${goalAmount.toLocaleString()}`;
                    if (progressBarFill) {
                        progressBarFill.style.width = `${Math.min(goalPercentage, 100)}%`;
                    }
                    if (progressText) {
                        progressText.textContent = `${Math.min(goalPercentage, 100)}% complete`;
                    }
                }
                savingsGoalSection.style.display = 'block';
            } else {
                savingsGoalSection.style.display = 'none';
            }
            
            // Add fade-in animations to dashboard cards
            const fadeCards = document.querySelectorAll('.fade-in-card');
            const cardObserver = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = `fadeInUp 0.6s ease-out ${index * 0.1}s forwards`;
                        cardObserver.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            fadeCards.forEach(card => {
                card.style.opacity = '0';
                cardObserver.observe(card);
            });

            // AI Chat functionality
            const chatBtn = document.getElementById('aiChatBtn');
            const chatPopup = document.getElementById('aiChatPopup');
            const chatCloseBtn = document.getElementById('chatCloseBtn');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatMessages = document.getElementById('chatMessages');

            // Toggle chat popup
            chatBtn.addEventListener('click', () => {
                chatPopup.classList.toggle('active');
            });

            chatCloseBtn.addEventListener('click', () => {
                chatPopup.classList.remove('active');
            });

            // Send message function
            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            function sendMessage() {
                const message = chatInput.value.trim();
                if (message === '') return;

                // Add user message to chat
                addMessage(message, 'user');
                chatInput.value = '';

                // Simulate AI response (placeholder for API integration)
                setTimeout(() => {
                    const aiResponse = getAIResponse(message);
                    addMessage(aiResponse, 'ai');
                }, 800);
            }

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;

                if (sender === 'ai') {
                    messageDiv.innerHTML = `
                        <div class="message-avatar">
                            <img src="../icons/chatbot2-icon.png" alt="AI">
                        </div>
                        <div class="message-content">
                            <p>${text}</p>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-avatar user-avatar">
                            <img src="../icons/user-icon.png" alt="User">
                        </div>
                        <div class="message-content">
                            <p>${text}</p>
                        </div>
                    `;
                }

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Placeholder AI response function - will be connected to backend
            function getAIResponse(userMessage) {

                // Placeholder responses for demo
                const responses = {
                    'show my spending': 'You\'ve spent ‚Ç±12,450 this month. Your top category is Food at ‚Ç±4,200. Would you like to see a detailed breakdown?',
                    'budget tips': 'Here are some tips: 1) Set aside 20% for savings first, 2) Track every expense, 3) Use the 50-30-20 rule for budgeting.',
                    'how can i save more?': 'Based on your spending, you could save ‚Ç±800/month by reducing dining out. Consider meal prepping to cut food costs by 30%.',
                    'savings goal progress': 'You\'re at 64% of your ‚Ç±5,000 goal! You\'ve saved ‚Ç±3,200 so far. Keep it up! üéâ'
                };

                const lowerMessage = userMessage.toLowerCase();
                for (const key in responses) {
                    if (lowerMessage.includes(key)) {
                        return responses[key];
                    }
                }

                return 'I understand you\'re asking about your finances. Let me help you with that! Could you be more specific about what you\'d like to know?';
            }

            // Quick action buttons
            window.sendQuickAction = function(action) {
                addMessage(action, 'user');
                setTimeout(() => {
                    const aiResponse = getAIResponse(action);
                    addMessage(aiResponse, 'ai');
                }, 800);
            };
        });
    </script>
</body>
</html>
